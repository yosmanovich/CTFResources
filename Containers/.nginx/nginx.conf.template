
map $http_api_key $valid_key {
    default 0;
    "${USER_KEY}" 1;
    "${ADMIN_KEY}" 2;
}
server {
    listen 80;
    
    location /api/create {
        if ($valid_key = 0) {
            return 401; # Unauthorized
        }        
        if ($valid_key = 1) {
            return 401; # Forbidden
        }        
        proxy_pass ${OLLAMA_BASE_URL}/api/create;
        proxy_http_version 1.1;
    }    

    location /api/blobs {
        if ($valid_key = 0) {
            return 401; # Unauthorized
        }        
        if ($valid_key = 1) {
            return 403; # Forbidden
        }        
        proxy_pass ${OLLAMA_BASE_URL}/api/blobs;
        proxy_http_version 1.1;
    }     

    location /api/embeddings {
        if ($valid_key = 0) {
            return 401; # Unauthorized
        }        
        if ($valid_key = 1) {
            return 403; # Forbidden
        }        
        proxy_pass ${OLLAMA_BASE_URL}/api/embeddings;
        proxy_http_version 1.1;
    }       

    location /api/embed {
        if ($valid_key = 0) {
            return 401; # Unauthorized
        }        
        if ($valid_key = 1) {
            return 403; # Forbidden
        }        
        proxy_pass ${OLLAMA_BASE_URL}/api/embed;
        proxy_http_version 1.1;
    }      

    location /api/push {
        if ($valid_key = 0) {
            return 401; # Unauthorized
        }        
        if ($valid_key = 1) {
            return 403; # Forbidden
        }        
        proxy_pass ${OLLAMA_BASE_URL}/api/push;
        proxy_http_version 1.1;
    }   

    location /api/pull {
        if ($valid_key = 0) {
            return 401; # Unauthorized
        }        
        if ($valid_key = 1) {
            return 403; # Forbidden
        }        
        proxy_pass ${OLLAMA_BASE_URL}/api/pull;
        proxy_http_version 1.1;
    }   

    location /api/delete {
        if ($valid_key = 0) {
            return 401; # Unauthorized
        }        
        if ($valid_key = 1) {
            return 403; # Forbidden
        }        
        proxy_pass ${OLLAMA_BASE_URL}/api/delete;
        proxy_http_version 1.1;
    }   

    location /api/version {
        if ($valid_key = 0) {
            return 401; # Unauthorized
        }        
        if ($valid_key = 1) {
            return 403; # Forbidden
        }        
        proxy_pass ${OLLAMA_BASE_URL}/api/version;
        proxy_http_version 1.1;
    }                         

    #/api/show
    #/api/chat
    #/api/tags
    location /api {
        if ($valid_key = 0) {
            return 401; # Unauthorized
        }        
        proxy_pass ${OLLAMA_BASE_URL}/api;
        proxy_http_version 1.1;

        proxy_connect_timeout 60s;
        proxy_read_timeout 1800s;
        proxy_send_timeout 1800s;
        send_timeout 1800s;        
    }
    
    location / {
        return 404;
    }
}